name: Deploy & Notify

on:
  workflow_run:
    workflows: ["Test & Build"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Deploy to environment
        run: |
          echo "Deploying ${{ github.event.workflow_run.head_commit }} to production..."
          # Add your deployment commands here
          # Examples:
          # - kubectl apply -f k8s/
          # - docker pull && docker run
          # - ansible-playbook deploy.yml

      - name: Send deployment notification
        if: always()
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "SKIP: SLACK_WEBHOOK_URL not configured, not sending deployment notification."
            exit 0
          fi
          payload='{
            "text":"üöÄ Deployment Status",
            "blocks":[
              {"type":"section","text":{"type":"mrkdwn","text":"üöÄ *Deployment Complete*\\n*Environment:* Production\\n*Branch:* main\\n*Commit:* ${{ github.event.workflow_run.head_commit }}" }}
            ]
          }'
          curl -s -X POST -H 'Content-type: application/json' --data "$payload" "${{ secrets.SLACK_WEBHOOK_URL }}"

  notify-failure:
    name: Notify on Test Failure
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'

    steps:
      - name: Send failure notification to Slack
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "SKIP: SLACK_WEBHOOK_URL not configured, not sending failure alert."
            exit 0
          fi
          payload='{
            "text":"‚ö†Ô∏è Pipeline Failed",
            "blocks":[
              {"type":"section","text":{"type":"mrkdwn","text":"‚ö†Ô∏è *Pipeline Failed - Manual Intervention Needed*\\n*Workflow:* ${{ github.event.workflow_run.name }}\\n*Branch:* ${{ github.event.workflow_run.head_branch }}\\n*Commit:* ${{ github.event.workflow_run.head_commit }}" }},
              {"type":"section","text":{"type":"mrkdwn","text":"<${{ github.event.workflow_run.html_url }}|View Workflow>" }}
            ]
          }'
          curl -s -X POST -H 'Content-type: application/json' --data "$payload" "${{ secrets.SLACK_WEBHOOK_URL }}"

      - name: Send email alert (if configured)
        if: always()
        run: |
          if [ -z "${{ secrets.EMAIL_SERVER }}" ] || [ -z "${{ secrets.EMAIL_USERNAME }}" ] || [ -z "${{ secrets.EMAIL_PASSWORD }}" ] || [ -z "${{ secrets.EMAIL_RECIPIENTS }}" ]; then
            echo "SKIP: Email credentials not fully configured, not sending email alert."
            exit 0
          fi
          
          SUBJECT="‚ö†Ô∏è CI Pipeline Failed - ${{ github.repository }}"
          BODY="Pipeline Failed!\\n\\nRepository: ${{ github.repository }}\\nWorkflow: ${{ github.event.workflow_run.name }}\\nBranch: ${{ github.event.workflow_run.head_branch }}\\nCommit: ${{ github.event.workflow_run.head_commit }}\\n\\nAction Required: Please review the workflow logs immediately.\\n\\nView details: ${{ github.event.workflow_run.html_url }}"
          
          echo "Email alert would be sent to: ${{ secrets.EMAIL_RECIPIENTS }}"
          echo "Subject: $SUBJECT"
          # Note: For actual email sending, use a GitHub Action or configure SMTP

      - name: Create issue for failed workflow
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ö†Ô∏è Test & Build Failed - ${context.payload.workflow_run.head_commit.substring(0, 7)}`,
              body: `## Pipeline Failure Report

**Workflow:** ${{ github.event.workflow_run.name }}
**Branch:** ${{ github.event.workflow_run.head_branch }}
**Commit:** ${{ github.event.workflow_run.head_commit }}
**Author:** ${{ github.event.workflow_run.actor.login }}

[View Workflow Run](${{ github.event.workflow_run.html_url }})

### Action Required
Please review the workflow logs and fix the failing tests before merging.

### Related
- Workflow: ${{ github.event.workflow_run.html_url }}
- Repository: ${{ github.repository }}`,
              labels: ['bug', 'ci-failure']
            });
            console.log(`Created issue #${issue.data.number}`);
