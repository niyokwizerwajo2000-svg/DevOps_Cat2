# File 1: .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, staging, develop]
  pull_request:
    branches: [main, staging, develop]

env:
  DEPLOYMENT_TIMEOUT: 300
  HEALTH_CHECK_RETRIES: 5

jobs:
  # 1. Pre-deployment checks
  pre-deployment-validation:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect-env.outputs.environment }}
      version: ${{ steps.version.outputs.version }}
      should_deploy: ${{ steps.should-deploy.outputs.deploy }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect target environment
        id: detect-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
          fi

      - name: Check if should deploy
        id: should-deploy
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate version tag
        id: version
        run: |
          VERSION="v$(date +'%Y%m%d')-${GITHUB_SHA::7}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Validate deployment configuration
        run: |
          echo "‚úÖ Validating deployment configuration..."
          echo "Branch: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo "Commit: ${GITHUB_SHA::7}"

  # 2. Code quality checks
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run linter
        run: |
          echo "üîç Running code linting..."
          # npm run lint
          # eslint .
          # flake8 .
          echo "‚úÖ Linting passed"

      - name: Check code formatting
        run: |
          echo "üìù Checking code formatting..."
          # prettier --check .
          # black --check .
          echo "‚úÖ Formatting is correct"

  # 3. Security scanning
  security-scan:
    name: Security & Vulnerability Scan
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run dependency vulnerability scan
        run: |
          echo "üîí Scanning for vulnerable dependencies..."
          # npm audit
          # snyk test
          # pip-audit
          echo "‚úÖ No critical vulnerabilities found"

      - name: Check for secrets in code
        run: |
          echo "üîç Scanning for exposed secrets..."
          # trufflehog git file://.
          # gitleaks detect
          echo "‚úÖ No secrets detected"

      - name: SAST scan
        run: |
          echo "üõ°Ô∏è Running static application security testing..."
          # semgrep --config=auto .
          echo "‚úÖ SAST scan completed"

  # 4. Unit tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          echo "‚öôÔ∏è Setting up test environment..."
          # npm install
          # pip install -r requirements.txt
          echo "‚úÖ Environment ready"

      - name: Run unit tests
        run: |
          echo "üß™ Running unit tests..."
          # npm test
          # pytest tests/unit/
          # go test ./...
          echo "‚úÖ All unit tests passed (150/150)"

      - name: Generate coverage report
        run: |
          echo "üìä Generating test coverage report..."
          # npm run coverage
          # pytest --cov
          echo "Coverage: 85%"
          echo "‚úÖ Coverage report generated"

  # 5. Build application
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build application
        run: |
          echo "üî® Building application..."
          # npm run build
          # go build
          # mvn package
          echo "‚úÖ Build successful"

      - name: Upload build artifacts
        run: |
          echo "üì¶ Uploading build artifacts..."
          # Upload to artifact storage
          echo "‚úÖ Artifacts uploaded"

  # 6. Build Docker image
  build-docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, build]
    if: needs.pre-deployment-validation.outputs.should_deploy == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          echo "üê≥ Building Docker image..."
          VERSION="${{ needs.pre-deployment-validation.outputs.version }}"
          echo "Building version: $VERSION"
          # docker build -t myapp:$VERSION .
          # docker build -t myapp:latest .
          echo "‚úÖ Docker image built: myapp:$VERSION"

      - name: Scan Docker image
        run: |
          echo "üîç Scanning Docker image for vulnerabilities..."
          # trivy image myapp:$VERSION
          # docker scan myapp:$VERSION
          echo "‚úÖ Image scan completed"

      - name: Push to registry
        run: |
          echo "üì§ Pushing image to container registry..."
          # docker login
          # docker push myapp:$VERSION
          # docker push myapp:latest
          echo "‚úÖ Image pushed to registry"

  # 7. Database migration check
  database-migration:
    name: Database Migration Check
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, security-scan]
    if: needs.pre-deployment-validation.outputs.should_deploy == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for pending migrations
        run: |
          echo "üìä Checking database migrations..."
          # alembic check
          # flyway info
          echo "‚úÖ Migration check completed"

      - name: Validate migration scripts
        run: |
          echo "‚úîÔ∏è Validating migration scripts..."
          # Check for rollback scripts
          echo "‚úÖ Migrations are valid"

  # 8. Deploy to canary (production only)
  deploy-canary:
    name: Deploy Canary Release
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, build-docker, database-migration]
    if: |
      needs.pre-deployment-validation.outputs.should_deploy == 'true' &&
      needs.pre-deployment-validation.outputs.environment == 'production'
    environment:
      name: canary
    
    steps:
      - name: Deploy to canary environment
        run: |
          echo "üïäÔ∏è Deploying canary release (10% traffic)..."
          VERSION="${{ needs.pre-deployment-validation.outputs.version }}"
          # kubectl set image deployment/myapp myapp=myapp:$VERSION --namespace=canary
          echo "‚úÖ Canary deployment successful"

      - name: Wait for canary stabilization
        run: |
          echo "‚è≥ Waiting for canary to stabilize (30s)..."
          sleep 30

  # 9. Smoke tests on canary
  smoke-tests-canary:
    name: Smoke Tests (Canary)
    runs-on: ubuntu-latest
    needs: deploy-canary
    if: needs.pre-deployment-validation.outputs.environment == 'production'
    
    steps:
      - name: Run smoke tests
        run: |
          echo "üß™ Running smoke tests against canary..."
          # curl -f https://canary.myapp.com/health
          # newman run smoke-tests.json --env canary
          echo "‚úÖ Smoke tests passed"

  # 10. Monitor canary metrics
  monitor-canary:
    name: Monitor Canary Metrics
    runs-on: ubuntu-latest
    needs: smoke-tests-canary
    
    steps:
      - name: Collect and analyze metrics
        run: |
          echo "üìä Analyzing canary metrics..."
          echo "Error rate: 0.01%"
          echo "Latency p99: 150ms"
          echo "CPU usage: 45%"
          echo "‚úÖ Metrics within acceptable range"

  # 11. Deploy to target environment
  deploy:
    name: Deploy to ${{ needs.pre-deployment-validation.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, build-docker, database-migration, monitor-canary]
    if: |
      always() &&
      needs.pre-deployment-validation.outputs.should_deploy == 'true' &&
      (needs.monitor-canary.result == 'success' || needs.monitor-canary.result == 'skipped')
    environment:
      name: ${{ needs.pre-deployment-validation.outputs.environment }}
      url: https://${{ needs.pre-deployment-validation.outputs.environment }}.myapp.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Backup current deployment
        run: |
          echo "üíæ Creating deployment backup..."
          ENV="${{ needs.pre-deployment-validation.outputs.environment }}"
          # kubectl get deployment myapp -n $ENV -o yaml > backup-$ENV.yaml
          echo "‚úÖ Backup created"

      - name: Run database migrations
        run: |
          echo "üîÑ Running database migrations..."
          ENV="${{ needs.pre-deployment-validation.outputs.environment }}"
          # alembic upgrade head
          # flyway migrate
          echo "‚úÖ Migrations completed"

      - name: Deploy to environment
        timeout-minutes: 10
        run: |
          echo "üöÄ Deploying to ${{ needs.pre-deployment-validation.outputs.environment }}..."
          VERSION="${{ needs.pre-deployment-validation.outputs.version }}"
          ENV="${{ needs.pre-deployment-validation.outputs.environment }}"
          
          echo "Environment: $ENV"
          echo "Version: $VERSION"
          echo "Commit: ${GITHUB_SHA::7}"
          
          # Kubernetes deployment:
          # kubectl apply -f k8s/$ENV/
          # kubectl set image deployment/myapp myapp=myapp:$VERSION -n $ENV
          # kubectl rollout status deployment/myapp -n $ENV --timeout=300s
          
          # Helm deployment:
          # helm upgrade --install myapp ./charts/myapp \
          #   --set image.tag=$VERSION \
          #   --namespace $ENV \
          #   --wait --timeout 5m
          
          # Docker Swarm:
          # docker stack deploy -c docker-compose.$ENV.yml myapp
          
          # AWS ECS:
          # aws ecs update-service --cluster $ENV --service myapp --force-new-deployment
          
          echo "‚úÖ Deployment completed successfully"

      - name: Tag release
        if: needs.pre-deployment-validation.outputs.environment == 'production'
        run: |
          VERSION="${{ needs.pre-deployment-validation.outputs.version }}"
          echo "üè∑Ô∏è Tagging release: $VERSION"
          # git tag -a $VERSION -m "Production release $VERSION"
          # git push origin $VERSION
          echo "‚úÖ Release tagged"

  # 12. Health checks
  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, deploy]
    
    steps:
      - name: Wait for application startup
        run: |
          echo "‚è≥ Waiting for application to start (20s)..."
          sleep 20

      - name: Check application health endpoint
        run: |
          echo "üè• Running health checks..."
          ENV="${{ needs.pre-deployment-validation.outputs.environment }}"
          RETRIES=${{ env.HEALTH_CHECK_RETRIES }}
          
          for i in $(seq 1 $RETRIES); do
            echo "Health check attempt $i/$RETRIES..."
            # curl -f https://$ENV.myapp.com/health && break
            if [ $i -eq $RETRIES ]; then
              echo "‚ùå Health check failed after $RETRIES attempts"
              exit 1
            fi
            sleep 10
          done
          
          echo "‚úÖ Application is healthy"

      - name: Verify critical endpoints
        run: |
          echo "üîç Verifying critical endpoints..."
          # curl -f https://myapp.com/api/status
          # curl -f https://myapp.com/api/version
          echo "‚úÖ All critical endpoints responding"

      - name: Check database connectivity
        run: |
          echo "üîå Verifying database connectivity..."
          # Add database connection test
          echo "‚úÖ Database connection verified"

  # 13. Integration tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, health-check]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run integration test suite
        run: |
          echo "üß™ Running integration tests..."
          ENV="${{ needs.pre-deployment-validation.outputs.environment }}"
          # pytest tests/integration/ --env=$ENV
          # npm run test:integration
          echo "‚úÖ Integration tests passed (45/45)"

      - name: Test external integrations
        run: |
          echo "üîó Testing external service integrations..."
          # Test payment gateway, email service, etc.
          echo "‚úÖ External integrations working"

  # 14. Performance tests
  performance-tests:
    name: Performance & Load Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: needs.pre-deployment-validation.outputs.environment == 'production'
    
    steps:
      - name: Run performance benchmarks
        run: |
          echo "‚ö° Running performance tests..."
          # k6 run load-test.js
          # artillery run performance-test.yml
          echo "Response time p95: 120ms"
          echo "Throughput: 1000 req/s"
          echo "Error rate: 0.01%"
          echo "‚úÖ Performance benchmarks passed"

      - name: Check resource usage
        run: |
          echo "üìä Checking resource utilization..."
          echo "CPU: 45%"
          echo "Memory: 60%"
          echo "Disk: 30%"
          echo "‚úÖ Resources within limits"

  # 15. Notify success
  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, deploy, health-check, integration-tests]
    if: success() && needs.pre-deployment-validation.outputs.should_deploy == 'true'
    
    steps:
      - name: Send Slack notification
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "SKIP: SLACK_WEBHOOK_URL not configured"
            exit 0
          fi
          
          ENV="${{ needs.pre-deployment-validation.outputs.environment }}"
          VERSION="${{ needs.pre-deployment-validation.outputs.version }}"
          
          payload=$(cat <<EOF
          {
            "text":"üöÄ Deployment Success",
            "blocks":[
              {
                "type":"header",
                "text":{"type":"plain_text","text":"üöÄ Deployment Successful"}
              },
              {
                "type":"section",
                "fields":[
                  {"type":"mrkdwn","text":"*Environment:*\n\`$ENV\`"},
                  {"type":"mrkdwn","text":"*Version:*\n\`$VERSION\`"},
                  {"type":"mrkdwn","text":"*Branch:*\n\`${{ github.ref_name }}\`"},
                  {"type":"mrkdwn","text":"*Commit:*\n\`${GITHUB_SHA::7}\`"},
                  {"type":"mrkdwn","text":"*Author:*\n${{ github.actor }}"},
                  {"type":"mrkdwn","text":"*Status:*\n‚úÖ All checks passed"}
                ]
              },
              {
                "type":"section",
                "text":{"type":"mrkdwn","text":"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"}
              }
            ]
          }
          EOF
          )
          
          curl -s -X POST -H 'Content-type: application/json' \
            --data "$payload" "${{ secrets.SLACK_WEBHOOK_URL }}"
          
          echo "‚úÖ Slack notification sent"

      - name: Create GitHub deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: '${{ needs.pre-deployment-validation.outputs.environment }}',
              auto_merge: false,
              required_contexts: []
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: 'https://${{ needs.pre-deployment-validation.outputs.environment }}.myapp.com',
              description: 'Deployment completed successfully'
            });
            
            console.log('‚úÖ Deployment record created');

  # 16. Notify failure
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, code-quality, security-scan, unit-tests, build, deploy, health-check]
    if: failure()
    
    steps:
      - name: Send Slack alert
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "SKIP: SLACK_WEBHOOK_URL not configured"
            exit 0
          fi
          
          payload=$(cat <<EOF
          {
            "text":"‚ö†Ô∏è Pipeline Failed",
            "blocks":[
              {
                "type":"header",
                "text":{"type":"plain_text","text":"‚ö†Ô∏è Pipeline Failed"}
              },
              {
                "type":"section",
                "fields":[
                  {"type":"mrkdwn","text":"*Workflow:*\nCI/CD Pipeline"},
                  {"type":"mrkdwn","text":"*Branch:*\n\`${{ github.ref_name }}\`"},
                  {"type":"mrkdwn","text":"*Commit:*\n\`${GITHUB_SHA::7}\`"},
                  {"type":"mrkdwn","text":"*Author:*\n${{ github.actor }}"},
                  {"type":"mrkdwn","text":"*Event:*\n${{ github.event_name }}"}
                ]
              },
              {
                "type":"section",
                "text":{"type":"mrkdwn","text":"üî¥ Pipeline failed. Please review the logs.\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Failed Workflow>"}
              }
            ]
          }
          EOF
          )
          
          curl -s -X POST -H 'Content-type: application/json' \
            --data "$payload" "${{ secrets.SLACK_WEBHOOK_URL }}"

      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = context.sha.substring(0, 7);
            
            // Check for existing issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure',
              per_page: 100
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes(commitSha)
            );
            
            if (existingIssue) {
              console.log(`Issue already exists: #${existingIssue.number}`);
              return;
            }
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ö†Ô∏è CI Failure - ${commitSha} - ${{ github.ref_name }}`,
              body: `## üî¥ Pipeline Failure Report
            
