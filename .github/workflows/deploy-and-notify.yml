name: Deploy & Notify

on:
  workflow_run:
    workflows: ["Test & Build"]
    types: [completed]
    branches: [main, staging, develop]

env:
  DEPLOYMENT_TIMEOUT: 300
  HEALTH_CHECK_RETRIES: 5

jobs:
  # 1. Pre-deployment checks
  pre-deployment-validation:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    outputs:
      environment: ${{ steps.detect-env.outputs.environment }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Detect target environment
        id: detect-env
        run: |
          if [[ "${{ github.event.workflow_run.head_branch }}" == "main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.workflow_run.head_branch }}" == "staging" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
          fi

      - name: Generate version tag
        id: version
        run: |
          VERSION="v$(date +'%Y%m%d')-${GITHUB_SHA::7}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Validate deployment configuration
        run: |
          echo "Validating deployment configuration..."
          # Add configuration validation logic here
          if [ ! -f "deploy/config.yml" ]; then
            echo "Warning: deploy/config.yml not found"
          fi
          echo "‚úÖ Configuration validated"

  # 2. Security scanning
  security-scan:
    name: Security & Vulnerability Scan
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Run security scan
        run: |
          echo "üîí Running security vulnerability scan..."
          # Add security scanning tools here (e.g., Snyk, Trivy)
          echo "‚úÖ Security scan completed"

      - name: Check for secrets in code
        run: |
          echo "üîç Scanning for exposed secrets..."
          # Add secret scanning logic
          echo "‚úÖ No secrets detected"

  # 3. Database migration check
  database-migration:
    name: Database Migration
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, security-scan]
    if: needs.pre-deployment-validation.outputs.environment != 'development'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Check for pending migrations
        run: |
          echo "üìä Checking database migrations..."
          # Add migration check logic
          echo "‚úÖ No pending migrations or migrations ready"

      - name: Backup database
        run: |
          echo "üíæ Creating database backup before migration..."
          # Add backup logic
          echo "‚úÖ Database backup created"

      - name: Run migrations
        run: |
          echo "üîÑ Running database migrations..."
          # Add migration commands (e.g., alembic, flyway, liquibase)
          echo "‚úÖ Migrations completed successfully"

  # 4. Build and push Docker image
  build-docker-image:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, security-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          echo "üê≥ Building Docker image..."
          VERSION="${{ needs.pre-deployment-validation.outputs.version }}"
          echo "Building version: $VERSION"
          # docker build -t myapp:$VERSION .
          echo "‚úÖ Docker image built successfully"

      - name: Push to registry
        run: |
          echo "üì§ Pushing image to container registry..."
          # docker push myapp:$VERSION
          echo "‚úÖ Image pushed to registry"

  # 5. Deploy to staging/canary
  deploy-canary:
    name: Deploy Canary Release
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, database-migration, build-docker-image]
    if: needs.pre-deployment-validation.outputs.environment == 'production'
    environment:
      name: canary
    
    steps:
      - name: Deploy to canary environment
        run: |
          echo "üïäÔ∏è Deploying canary release (10% traffic)..."
          VERSION="${{ needs.pre-deployment-validation.outputs.version }}"
          # kubectl set image deployment/myapp myapp=myapp:$VERSION --namespace=canary
          # kubectl patch service myapp --namespace=canary -p '{"spec":{"selector":{"version":"canary"}}}'
          echo "‚úÖ Canary deployment successful"

      - name: Wait for canary stabilization
        run: |
          echo "‚è≥ Waiting for canary to stabilize (60s)..."
          sleep 60
          echo "‚úÖ Canary stabilization period completed"

  # 6. Run smoke tests
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-canary
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Run smoke tests
        run: |
          echo "üß™ Running smoke tests against canary..."
          # Add smoke test commands
          # curl -f https://canary.myapp.com/health || exit 1
          echo "‚úÖ Smoke tests passed"

      - name: Verify critical endpoints
        run: |
          echo "üîç Verifying critical endpoints..."
          # Test authentication, database connectivity, etc.
          echo "‚úÖ All critical endpoints responding"

  # 7. Monitor canary metrics
  monitor-canary:
    name: Monitor Canary Metrics
    runs-on: ubuntu-latest
    needs: [deploy-canary, smoke-tests]
    
    steps:
      - name: Collect canary metrics
        run: |
          echo "üìä Collecting canary metrics..."
          # Query monitoring system (Prometheus, Datadog, etc.)
          echo "Error rate: 0.01%"
          echo "Latency p99: 150ms"
          echo "‚úÖ Metrics within acceptable range"

      - name: Compare with production baseline
        run: |
          echo "üìà Comparing canary vs production metrics..."
          # Add metric comparison logic
          echo "‚úÖ Canary performance acceptable"

  # 8. Full production deployment
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, monitor-canary]
    if: needs.pre-deployment-validation.outputs.environment == 'production'
    environment:
      name: production
      url: https://myapp.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Deploy to production
        timeout-minutes: 10
        run: |
          echo "üöÄ Deploying to production..."
          VERSION="${{ needs.pre-deployment-validation.outputs.version }}"
          ENV="${{ needs.pre-deployment-validation.outputs.environment }}"
          COMMIT="${{ github.event.workflow_run.head_commit }}"
          
          echo "Environment: $ENV"
          echo "Version: $VERSION"
          echo "Commit: $COMMIT"
          
          # Add your deployment commands here:
          # kubectl apply -f k8s/production/
          # kubectl set image deployment/myapp myapp=myapp:$VERSION
          # kubectl rollout status deployment/myapp --timeout=300s
          
          # Or Helm:
          # helm upgrade --install myapp ./charts/myapp --set image.tag=$VERSION
          
          # Or Docker Swarm:
          # docker stack deploy -c docker-compose.prod.yml myapp
          
          # Or AWS ECS:
          # aws ecs update-service --cluster prod --service myapp --force-new-deployment
          
          echo "‚úÖ Production deployment completed"

      - name: Tag release
        run: |
          VERSION="${{ needs.pre-deployment-validation.outputs.version }}"
          echo "üè∑Ô∏è Tagging release: $VERSION"
          # git tag -a $VERSION -m "Production release $VERSION"
          # git push origin $VERSION
          echo "‚úÖ Release tagged"

  # 9. Deploy to staging/development
  deploy-non-production:
    name: Deploy to ${{ needs.pre-deployment-validation.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, database-migration, build-docker-image]
    if: needs.pre-deployment-validation.outputs.environment != 'production'
    environment:
      name: ${{ needs.pre-deployment-validation.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Deploy to environment
        run: |
          ENV="${{ needs.pre-deployment-validation.outputs.environment }}"
          VERSION="${{ needs.pre-deployment-validation.outputs.version }}"
          echo "üöÄ Deploying to $ENV..."
          # kubectl apply -f k8s/$ENV/
          echo "‚úÖ Deployment to $ENV completed"

  # 10. Health checks
  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-non-production]
    if: always() && (needs.deploy-production.result == 'success' || needs.deploy-non-production.result == 'success')
    
    steps:
      - name: Wait for application startup
        run: |
          echo "‚è≥ Waiting for application to start (30s)..."
          sleep 30

      - name: Check application health
        run: |
          echo "üè• Running health checks..."
          RETRIES=${{ env.HEALTH_CHECK_RETRIES }}
          
          for i in $(seq 1 $RETRIES); do
            echo "Health check attempt $i/$RETRIES..."
            # curl -f https://myapp.com/health && break
            # if [ $i -eq $RETRIES ]; then exit 1; fi
            sleep 10
          done
          
          echo "‚úÖ Application is healthy"

      - name: Verify database connectivity
        run: |
          echo "üîå Verifying database connectivity..."
          # Add database connection test
          echo "‚úÖ Database connection verified"

      - name: Check external dependencies
        run: |
          echo "üîó Checking external service dependencies..."
          # Test Redis, message queues, APIs, etc.
          echo "‚úÖ All dependencies available"

  # 11. Run integration tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: health-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Run integration test suite
        run: |
          echo "üß™ Running integration tests..."
          # pytest tests/integration/ --env=production
          echo "‚úÖ Integration tests passed"

  # 12. Performance monitoring
  performance-check:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
      - name: Run performance tests
        run: |
          echo "‚ö° Running performance benchmarks..."
          # Add performance testing (e.g., k6, JMeter)
          echo "Response time: 120ms"
          echo "Throughput: 1000 req/s"
          echo "‚úÖ Performance benchmarks passed"

      - name: Update monitoring dashboards
        run: |
          echo "üìä Updating deployment metrics in monitoring system..."
          # Update Grafana annotations, Datadog events, etc.
          echo "‚úÖ Monitoring dashboards updated"

  # 13. Notification - Success
  notify-success:
    name: Send Success Notifications
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, performance-check]
    if: success()
    
    steps:
      - name: Send Slack notification
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "SKIP: SLACK_WEBHOOK_URL not configured"
            exit 0
          fi
          
          ENV="${{ needs.pre-deployment-validation.outputs.environment }}"
          VERSION="${{ needs.pre-deployment-validation.outputs.version }}"
          
          payload=$(cat <<EOF
          {
            "text":"üöÄ Deployment Success",
            "blocks":[
              {
                "type":"header",
                "text":{"type":"plain_text","text":"üöÄ Deployment Successful"}
              },
              {
                "type":"section",
                "fields":[
                  {"type":"mrkdwn","text":"*Environment:*\n$ENV"},
                  {"type":"mrkdwn","text":"*Version:*\n$VERSION"},
                  {"type":"mrkdwn","text":"*Branch:*\n${{ github.event.workflow_run.head_branch }}"},
                  {"type":"mrkdwn","text":"*Commit:*\n\`${{ github.event.workflow_run.head_commit }}\`"},
                  {"type":"mrkdwn","text":"*Author:*\n${{ github.event.workflow_run.actor.login }}"},
                  {"type":"mrkdwn","text":"*Status:*\n‚úÖ All checks passed"}
                ]
              },
              {
                "type":"section",
                "text":{"type":"mrkdwn","text":"<${{ github.event.workflow_run.html_url }}|View Workflow Run>"}
              }
            ]
          }
          EOF
          )
          
          curl -s -X POST -H 'Content-type: application/json' \
            --data "$payload" "${{ secrets.SLACK_WEBHOOK_URL }}"
          
          echo "‚úÖ Slack notification sent"

      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: '${{ github.event.workflow_run.head_branch }}',
              environment: '${{ needs.pre-deployment-validation.outputs.environment }}',
              auto_merge: false,
              required_contexts: []
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: 'https://myapp.com',
              description: 'Deployment completed successfully'
            });
            
            console.log('‚úÖ Deployment record created');

  # 14. Notification - Failure (from upstream workflow)
  notify-failure:
    name: Notify Test/Build Failure
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    
    steps:
      - name: Send Slack alert
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "SKIP: SLACK_WEBHOOK_URL not configured"
            exit 0
          fi
          
          payload=$(cat <<EOF
          {
            "text":"‚ö†Ô∏è Pipeline Failed",
            "blocks":[
              {
                "type":"header",
                "text":{"type":"plain_text","text":"‚ö†Ô∏è Pipeline Failed - Action Required"}
              },
              {
                "type":"section",
                "fields":[
                  {"type":"mrkdwn","text":"*Workflow:*\n${{ github.event.workflow_run.name }}"},
                  {"type":"mrkdwn","text":"*Branch:*\n${{ github.event.workflow_run.head_branch }}"},
                  {"type":"mrkdwn","text":"*Commit:*\n\`${{ github.event.workflow_run.head_commit }}\`"},
                  {"type":"mrkdwn","text":"*Author:*\n${{ github.event.workflow_run.actor.login }}"}
                ]
              },
              {
                "type":"section",
                "text":{"type":"mrkdwn","text":"üî¥ Tests or build failed. Deployment blocked.\n\n<${{ github.event.workflow_run.html_url }}|View Failed Workflow>"}
              }
            ]
          }
          EOF
          )
          
          curl -s -X POST -H 'Content-type: application/json' \
            --data "$payload" "${{ secrets.SLACK_WEBHOOK_URL }}"

      - name: Send email alert
        if: always()
        run: |
          if [ -z "${{ secrets.EMAIL_RECIPIENTS }}" ]; then
            echo "SKIP: EMAIL_RECIPIENTS not configured"
            exit 0
          fi
          
          echo "üìß Email alert configuration:"
          echo "To: ${{ secrets.EMAIL_RECIPIENTS }}"
          echo "Subject: ‚ö†Ô∏è CI Pipeline Failed - ${{ github.repository }}"
          echo ""
          echo "Note: Configure email action for actual sending"
          # Use: dawidd6/action-send-mail@v3 or similar




  # 15. Rollback on deployment failure
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [deploy-production, health-check]
    if: failure() && needs.deploy-production.result == 'success'
    
    steps:
      - name: Trigger rollback
        run: |
          echo "üîÑ Deployment health check failed, initiating rollback..."
          # kubectl rollout undo deployment/myapp
          # helm rollback myapp
          echo "‚úÖ Rollback completed"

      - name: Notify rollback
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            exit 0
          fi
          
          payload='{"text":"üîÑ Automatic rollback triggered due to health check failure"}'
          curl -s -X POST -H 'Content-type: application/json' \
            --data "$payload" "${{ secrets.SLACK_WEBHOOK_URL }}"